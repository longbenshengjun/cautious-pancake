<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ごとうおんゲーム</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    body{margin:0;font-family:'Noto Sans JP',sans-serif;background:#f4f9ff;color:#222;} 
    .screen{display:none;padding:20px;max-width:900px;margin:auto;text-align:center;} 
    .active{display:block;} 
    button{padding:12px 20px;border:none;border-radius:12px;font-size:20px;background:#fff;border:2px solid #ccc;margin:8px;cursor:pointer;} 
    button:hover{border-color:#3a86ff;} 
    .kana{font-size:120px;font-weight:900;margin:20px 0;} 
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;} 
    .choice{background:#fff;border-radius:10px;padding:6px;border:3px solid transparent;} 
    .choice img{width:100%;height:auto;aspect-ratio:1/1;object-fit:contain;border-radius:8px;}  
    .choice.mozi{font-size:18px;margin-top:4px;} 
    .selected{border-color:#3a86ff;} 
    .blink{animation:blink 0.8s ease-in-out 3;} 
    @keyframes blink{0%{box-shadow:0 0 0 0 yellow;}50%{box-shadow:0 0 0 8px yellow;}100%{box-shadow:0 0 0 0 yellow;}} 
  </style>
</head>
<body>

<!-- ★ 1st screen：もじあり/もじなし → 行選択へ -->
<div id="screenStart" class="screen active">
  <h1>えをえらぶゲーム</h1>
  <p>えのしたのもじを<br>ひょうじする？</p>
  <button onclick="selectMoji('あり')">もじあり</button>
  <button onclick="selectMoji('なし')">もじなし</button>
</div>

<!-- ★ 2nd screen：行ボタンのみ表示 -->
<div id="screenRow" class="screen">
  <h2>ぎょうをえらんでね</h2>
  <div id="rowButtons"></div>
</div>

<!-- ★ 3rd：問題画面 -->
<div id="screenGame" class="screen">
  <div class="kana" id="qKana">あ</div>
  <div>とくてん：<span id="score">0</span>　もん：<span id="qnum">0</span>/<span id="qtotal">0</span></div>
  <div class="grid" id="choices"></div>
  <button onclick="checkAnswer()">できた</button>
  <button onclick="nextQuestion()">つぎへ</button>
  <div id="msg" style="margin-top:10px;font-weight:700"></div>
</div>

<audio id="ping" src="ping.mp3"></audio>

<script>
let mojiMode="あり";
let rowMode=null;

// ★ ことばリスト
const kanaWords={
  'あ':['あいす','あり','あか'],
  'い':['いす','いか','いちご'],
  'う':['うま','うし','うきわ'],
  'え':['えんぴつ','えのぐ','えんとつ'],
  'お':['おにぎり','おばけ','おに'],

  'か':['かに','かさ','かえる'],
  'き':['きいろ','きりん','きのこ'],
  'く':['くるま','くち','くわがた'],
  'け':['けしごむ','けいと','けんだま'],
  'こ':['こま','こあら','こうもり'],

  'さ':['さかな','さいころ','さる'],
  'し':['しんごう','しかく','しまうま'],
  'す':['すいか','すいとう','すず'],
  'せ':['せんぷうき','せみ','せなか'],
  'そ':['そり','そうじき','そうじ'],

  'た':['たいこ','たいやき','たまご'],
  'ち':['ちくわ','ちょうちん','ちゅうしゃ'],
  'つ':['つみき','つくし','つくえ'],
  'て':['てぶくろ','てれび','てんとうむし'],
  'と':['とけい','とまと','といれ'],

  'な':['なす','なわとび','ながぐつ'],
  'に':['にんじん','にじ','にわとり'],
  'ぬ':['ぬりえ','ぬいぐるみ','ぬま'],
  'ね':['ねこ','ねずみ','ねくたい'],
  'の':['のり','のこぎり','のびる'],

  'は':['はさみ','はち','はな'],
  'ひ':['ひよこ','ひこうき','ひつじ'],
  'ふ':['ふね','ふうせん','ふくろう'],
  'へ':['へび','へりこぷたー','へいきんだい'],
  'ほ':['ほし','ほたる','ほね'],

  'ま':['まめ','まいく','ますく'],
  'み':['みかん','みみ','みどり'],
  'む':['むしめがね','むかで','むらさき'],
  'め':['めがね','め','めろん'],
  'も':['もも','もち','もぐら'],

  'や':['やかん','やま','やきそば'],
  'ゆ':['ゆきだるま','ゆび','ゆーふぉー'],
  'よ':['よる','よん','よーぐると'],

  'ら':['らいおん','らっぱ','らくだ'],
  'り':['りんご','りす','りぼん'],
  'る':['るすばん','るーれっと','るびー'],
  'れ':['れもん','れいぞうこ','れんこん'],
  'ろ':['ろうそく','ろく','ろけっと'],

  'わ':['わに','わごむ','わかめ']
};

// 行ごと
const rows={
  "あぎょう":['あ','い','う','え','お'],
  "かぎょう":['か','き','く','け','こ'],
  "さぎょう":['さ','し','す','せ','そ'],
  "たぎょう":['た','ち','つ','て','と'],
  "なぎょう":['な','に','ぬ','ね','の'],
  "はぎょう":['は','ひ','ふ','へ','ほ'],
  "まぎょう":['ま','み','む','め','も'],
  "やぎょう":['や','ゆ','よ'],
  "らぎょう":['ら','り','る','れ','ろ'],
  "わぎょう":['わ']
};

// すべての単語
let allWords=[];
Object.values(kanaWords).forEach(a=>a.forEach(w=>allWords.push(w)));


// ★ 画面切替
function showScreen(id){
  console.log('showScreen', id);
  document.querySelectorAll('.screen').forEach(sc=>{
    sc.style.display = 'none';
  });
  const target = document.getElementById(id);
  if(target){
    target.style.display = 'block';
  } else {
    console.error('screen not found:', id);
  }
}

// ★ 修正済み selectMoji()
function selectMoji(type){
  console.log('moji select', type);
  mojiMode = type;
  buildRowButtons();
  showScreen('screenRow');
}


// 行ボタン生成
function buildRowButtons(){
  const box=document.getElementById('rowButtons');
  box.innerHTML="";
  const labels=["あぎょう","かぎょう","さぎょう","たぎょう","なぎょう","はぎょう","まぎょう","やぎょう","らぎょう","わぎょう","ぜんぶ"];
  labels.forEach(l=>{
    const b=document.createElement('button');
    b.textContent=l;
    b.onclick=()=>selectRow(l);
    box.appendChild(b);
  });
}

let qList=[];
let qIndex=0;
let score=0;
let correctSet=new Set();
let selectedSet=new Set();
let needCount=0;
let currentOptions=[];


// 行選択
function selectRow(r){
  rowMode=r;
  score=0;qIndex=0;

  if(r==="ぜんぶ"){
    qList=[];
    const keys=Object.keys(kanaWords);
    for(let i=0;i<20;i++) qList.push(keys[Math.floor(Math.random()*keys.length)]);
  } else {
    qList=shuffle([...rows[r]]);
  }

  document.getElementById('qtotal').textContent=qList.length;
  nextQuestion(true);
  showScreen('screenGame');
}


// 次の問題へ
function nextQuestion(first=false){
  if(!first) qIndex++;
  if(qIndex>=qList.length){
    alert(`さいごのとくてん：${score}`);
    showScreen('screenStart');
    return;
  }

  const kana=qList[qIndex];
  document.getElementById('qKana').textContent=kana;
  document.getElementById('qnum').textContent=qIndex+1;
  document.getElementById('score').textContent=score;
  document.getElementById('msg').textContent="";

  const words=kanaWords[kana];
  needCount=Math.random()<0.5?2:3;
  needCount=Math.min(needCount,words.length);

  const correct=shuffle([...words]).slice(0,needCount);
  correctSet=new Set(correct);

  const opts=[...correct];
  const pool=allWords.filter(w=>!opts.includes(w));
  while(opts.length<8) opts.push(pool.splice(Math.floor(Math.random()*pool.length),1)[0]);

  currentOptions=shuffle(opts);
  selectedSet=new Set();

  drawChoices();
}


// えの表示
function drawChoices(){
  const area=document.getElementById('choices');
  area.innerHTML="";
  currentOptions.forEach(w=>{
    const div=document.createElement('div');
    div.className='choice';
    div.onclick=()=>toggle(div);
    const img=document.createElement('img');
    img.src=`images/${w}.jpg`;
    img.alt=w;
    div.appendChild(img);
    if(mojiMode==="あり"){
      const mo=document.createElement('div');
      mo.className='mozi';
      mo.textContent=w;
      div.appendChild(mo);
    }
    area.appendChild(div);
  });
}

function toggle(div){
  const word=div.querySelector('img').alt;
  if(selectedSet.has(word)){
    selectedSet.delete(word);
    div.classList.remove('selected');
  } else {
    selectedSet.add(word);
    div.classList.add('selected');
  }
}

function checkAnswer(){
  const good=[...correctSet];
  const ok=selectedSet.size===good.length && [...selectedSet].every(x=>correctSet.has(x));
  const msg=document.getElementById('msg');
  const ping=document.getElementById('ping');

  document.querySelectorAll('.choice').forEach(div=>{
    div.classList.remove('blink');
  });

  if(ok){
    score+=5;
    document.getElementById('score').textContent=score;
    msg.textContent="せいかい！ +5てん";
    ping.currentTime=0;
    ping.play();
    setTimeout(()=>nextQuestion(),700);
  }else{
    msg.textContent="ちがうよ。せいかいがひかるよ";
    document.querySelectorAll('.choice').forEach(div=>{
      const w=div.querySelector('img').alt;
      if(correctSet.has(w)) div.classList.add('blink');
    });
  }
}

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
</script>

</body>
</html>
