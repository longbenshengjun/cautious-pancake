<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>たしざん</title>

<style>
:root{--accent:#ff3b30}
html,body{height:100%}
body{
  margin:0;padding:20px;
  font-family:"Kyokasho","Noto Sans JP",Meiryo,sans-serif;
  background:linear-gradient(180deg,#eef7ff,#fff);
  display:flex;align-items:center;justify-content:center;
}
.app{
  width:100%;max-width:720px;
  background:#fff;border-radius:16px;
  padding:28px;text-align:center;
  box-shadow:0 8px 30px rgba(0,0,0,.08);
}
h1{margin:0 0 12px}
.mode-buttons{display:flex;gap:12px;justify-content:center;margin-bottom:18px}
button.mode{padding:14px 22px;font-size:18px;border-radius:12px;border:0;cursor:pointer}
.game-area{display:none}
.question-box{font-size:36px;margin:18px 0;font-weight:700}
.answers{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
.answers button{
  width:56px;height:56px;border-radius:8px;border:0;
  font-size:20px;cursor:pointer;
}
.answers button:disabled{opacity:.6}

/* 正解を黄色く点滅 */
.answers button.correct-hint{
  background:#ffe066;
  box-shadow:0 0 14px rgba(255,224,102,.9);
  animation:blink .3s ease-in-out 2;
}

@keyframes blink{
  0%{transform:scale(1)}
  50%{transform:scale(1.15)}
  100%{transform:scale(1)}
}

.footer{display:flex;justify-content:space-between;margin-top:16px}
.overlay{
  position:fixed;inset:0;
  display:flex;align-items:center;justify-content:center;
  pointer-events:none;
}
.big-red,.big-q{
  width:200px;height:200px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:120px;font-weight:900;color:#fff;
  transform:scale(0);
  transition:transform .25s cubic-bezier(.2,.9,.3,1);
}
.big-red{background:var(--accent)}
.big-q{background:rgba(0,0,0,.7)}
.big-visible{transform:scale(1)}
.result-screen{display:none}
</style>
</head>

<body>
<div class="app">
  <h1>たしざん</h1>

  <div class="start-screen">
    <div class="mode-buttons">
      <button class="mode" id="mode5">5まで</button>
      <button class="mode" id="mode10">10まで</button>
    </div>
  </div>

  <div class="game-area" id="gameArea">
    <div id="progress">もんだい 1 / 10</div>
    <div class="question-box" id="questionBox"></div>
    <div class="answers" id="answers"></div>
    <div class="footer">
      <div id="score">すこあ: 0</div>
    </div>
  </div>

  <div class="result-screen" id="resultScreen">
    <h2>おわり！</h2>
    <p id="finalScore"></p>
    <button id="restartBtn">もういちど</button>
  </div>

  <audio id="correctSound" src="sounds/correct.mp3"></audio>
</div>

<div class="overlay">
  <div class="big-red" id="bigRed">○</div>
  <div class="big-q" id="bigQ">？</div>
</div>

<script>
(() => {
  const mode5 = document.getElementById('mode5');
  const mode10 = document.getElementById('mode10');
  const gameArea = document.getElementById('gameArea');
  const questionBox = document.getElementById('questionBox');
  const answers = document.getElementById('answers');
  const progress = document.getElementById('progress');
  const scoreEl = document.getElementById('score');
  const resultScreen = document.getElementById('resultScreen');
  const finalScore = document.getElementById('finalScore');
  const restartBtn = document.getElementById('restartBtn');
  const correctSound = document.getElementById('correctSound');
  const bigRed = document.getElementById('bigRed');
  const bigQ = document.getElementById('bigQ');

  let problems = [];
  let current = 0;
  let totalScore = 0;
  let hasMistake = false; // この問題で一度でも間違えたか

  function pickProblems(max){
    const list=[];
    while(list.length<10){
      const sum=Math.floor(Math.random()*max)+1;
      const a=Math.floor(Math.random()*(sum-1))+1;
      list.push({a,b:sum-a,sum});
    }
    return list;
  }

  function startGame(max){
    problems=pickProblems(max);
    current=0;
    totalScore=0;
    document.querySelector('.start-screen').style.display='none';
    resultScreen.style.display='none';
    gameArea.style.display='block';
    updateHUD();
    showProblem();
  }

  function updateHUD(){
    progress.textContent=`もんだい ${current+1} / 10`;
    scoreEl.textContent=`すこあ: ${totalScore}`;
  }

  function showProblem(){
    const p=problems[current];
    hasMistake=false; // リセット
    questionBox.textContent=`${p.a} + ${p.b} = ?`;
    answers.innerHTML='';
    for(let i=1;i<=10;i++){
      const b=document.createElement('button');
      b.textContent=i;
      b.dataset.val=i;
      b.onclick=onAnswer;
      answers.appendChild(b);
    }
  }

  function onAnswer(e){
    const val=Number(e.currentTarget.dataset.val);
    const p=problems[current];

    if(val===p.sum){
      if(!hasMistake){
        totalScore+=10; // 一発正解のみ加点
      }
      disableAll();
      updateHUD();
      showBigRed();
      correctSound.currentTime=0;
      correctSound.play().catch(()=>{});
    }else{
      hasMistake=true;
      highlightCorrect(p.sum);
      showBigQ();
    }
  }

  function highlightCorrect(correct){
    const btn=answers.querySelector(`button[data-val="${correct}"]`);
    if(!btn) return;
    btn.classList.remove('correct-hint');
    void btn.offsetWidth; // 再点滅用
    btn.classList.add('correct-hint');
  }

  function disableAll(){
    [...answers.children].forEach(b=>b.disabled=true);
  }

  function showBigRed(){
    bigRed.classList.add('big-visible');
    setTimeout(()=>{
      bigRed.classList.remove('big-visible');
      next();
    },700);
  }

  function showBigQ(){
    bigQ.classList.add('big-visible');
    setTimeout(()=>bigQ.classList.remove('big-visible'),400);
  }

  function next(){
    current++;
    if(current>=10){
      gameArea.style.display='none';
      resultScreen.style.display='block';
      finalScore.textContent=`${totalScore} / 100`;
      return;
    }
    updateHUD();
    showProblem();
  }

  mode5.onclick=()=>startGame(5);
  mode10.onclick=()=>startGame(10);
  restartBtn.onclick=()=>location.reload();
})();
</script>
</body>
</html>
